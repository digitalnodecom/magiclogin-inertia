function magic_script(){let e="https://magic.mk",t=document.getElementById("magic-form"),i=document.getElementById("magic-input"),n=document.getElementById("magic-submit"),a=document.getElementById("magic-form");if(!t){console.log("Could not find the div with id 'magic-form'");return}i&&n||(a.innerHTML=`
            <input id="magic-input" required>
            <button id="magic-submit"> Sign in without password</button>
            <p id="validation-message"></p>`,i=document.getElementById("magic-input"),n=document.getElementById("magic-submit"));let o=e=>/^[A-Za-z0-9_.+-]+@[A-Za-z0-9-]+\.[A-Za-z]{2,4}$/.test(e);function l(e){let t=e.redirect_url||window.magicmk.redirect_url;if(t){let i=new URL(t);i.searchParams.append("type","magic"),i.searchParams.append("token",e.token),i.searchParams.append("project",window.magicmk.project_slug),i.searchParams.append("request_id",e.request_id),window.location.replace(i.toString())}else{let n=window.location.href+"magic-login/?request_id="+e.request_id+"&token="+e.token;window.location.replace(n)}}function r(e){let t=new CustomEvent("magicauth-success",{detail:{token:e.token,project:window.magicmk.project_slug,request_id:e.request_id}});dispatchEvent(t)}n.addEventListener("click",t=>{if(t.preventDefault(),n.disabled=!0,!o(i.value)){document.getElementById("validation-message").textContent=`Invalid email: ${i.value}`,n.disabled=!1;return}let s={email:i.value};window.magicmk&&Object.assign(s,window.magicmk),fetch(`${e}/api/login/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(e=>e.ok?e.json():null).then(t=>{var o;if(!t||!t.request_id){a.innerHTML='<div>Something went wrong. <a href=".">Try again.</a></div>',n.disabled=!1;return}t.project_type_link?function t(n){a.innerHTML=`<p id="sent-title">A <b>verification link</b> has been sent to: ${i.value}</p>`;let o=setInterval(()=>{fetch(`${e}/api/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_slug:window.magicmk.project_slug,request_id:n.request_id})}).then(e=>200===e.status?e.json():null).then(e=>{e&&e.token&&(a.querySelector("#sent-title").textContent="Login Successful!",clearInterval(o),l(e),r(e))})},2e3)}(t):(o=t,a.innerHTML+=`<p id="sent-title">A <b>verification code</b> has been sent to: ${i.value}</p>`,i=document.getElementById("magic-input"),(n=document.getElementById("magic-submit")).innerText="Enter Code",n.disabled=!1,i.value="",(n=document.getElementById("magic-submit")).addEventListener("click",t=>{t.preventDefault();let n={code:i.value,request_id:o.request_id};fetch(`${e}/api/code_validate/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>e.json()).then(e=>{e.consumed?(a.querySelector("#sent-title").textContent="Login Successful!",l(e),r(e)):a.querySelector("#sent-title").textContent="Login failed, try again!"})}))}).catch(()=>n.disabled=!1)})}
